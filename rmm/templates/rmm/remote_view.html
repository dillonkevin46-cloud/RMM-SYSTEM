<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Remote Control - {{ agent_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; height: 100vh; overflow: hidden; }
        #remote-screen {
            width: 100%;
            height: 90vh;
            object-fit: contain; /* Keeps aspect ratio */
            border: 1px solid #333;
        }
        .toolbar { height: 10vh; background: #222; display: flex; align-items: center; padding: 0 20px; }
    </style>
</head>
<body>

    <div class="toolbar">
        <h5 class="m-0 me-4">Connected to: {{ agent_id }}</h5>
        <button class="btn btn-danger btn-sm" onclick="window.close()">Disconnect</button>
        <span class="ms-auto text-muted" id="status">Connecting...</span>
    </div>

    <img id="remote-screen" src="" alt="Waiting for stream...">

    <script>
    const agentId = "{{ agent_id }}";
    const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
    const wsUrl = protocol + window.location.host + "/ws/remote/" + agentId + "/";
    
    const socket = new WebSocket(wsUrl);
    socket.binaryType = "arraybuffer";

    const img = document.getElementById("remote-screen");
    const status = document.getElementById("status");

    // --- 1. Video Handling ---
    socket.onmessage = function(event) {
        const blob = new Blob([event.data], {type: "image/jpeg"});
        const url = URL.createObjectURL(blob);
        img.onload = () => URL.revokeObjectURL(url);
        img.src = url;
    };

    socket.onopen = () => { status.innerText = "Connected"; status.style.color = "#00ff00"; };
    socket.onclose = () => { status.innerText = "Disconnected"; status.style.color = "red"; };

    // --- 2. Input Handling ---
    
    // Helper to send JSON command
    function sendCommand(data) {
        if(socket.readyState === WebSocket.OPEN) {
            socket.send(JSON.stringify(data));
        }
    }

    // Mouse Move
    img.addEventListener('mousemove', (e) => {
        // Calculate position as percentage (0.0 to 1.0)
        const rect = img.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        
        sendCommand({type: 'mousemove', x: x, y: y});
    });

    // Mouse Click
    img.addEventListener('mousedown', (e) => {
        sendCommand({type: 'mousedown', button: e.button});
    });
    
    img.addEventListener('mouseup', (e) => {
        sendCommand({type: 'mouseup', button: e.button});
    });

    // Keyboard (Basic)
    document.addEventListener('keydown', (e) => {
        // Prevent default browser actions for some keys (like F5 or Ctrl+S)
        if(["Tab", "Alt", "F5"].includes(e.key)) e.preventDefault();
        
        sendCommand({type: 'keypress', key: e.key});
    });

</script>
</body>
</html>