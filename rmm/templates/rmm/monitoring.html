{% extends 'rmm/base.html' %}

{% block content %}
    <div class="d-flex justify-content-between mb-4">
        <h2>ðŸ“ˆ System Monitoring</h2>
        <div>
             {% if selected_agent %}
                <a href="{% url 'terminal_view' selected_agent.agent_id %}" class="btn btn-dark border-success text-success ms-2">
                    ðŸ’» Open Terminal
                </a>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-3">
            <div class="list-group">
                {% for agent in agents %}
                <a href="?agent_id={{ agent.id }}" class="list-group-item list-group-item-action bg-dark text-white border-secondary {% if selected_agent.id == agent.id %}active{% endif %}">
                    {{ agent.hostname }}
                    {% if agent.is_online %}
                        <span class="badge bg-success float-end">On</span>
                    {% else %}
                        <span class="badge bg-danger float-end">Off</span>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
        </div>

        <div class="col-md-9">
            {% if selected_agent %}
                <h4 class="mb-3">Performance: {{ selected_agent.hostname }}</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card bg-dark border-secondary p-2">
                            <h6 class="text-center">System Resources (%)</h6>
                            <canvas id="resourceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="card bg-dark border-secondary p-2">
                            <h6 class="text-center">Network Latency (ms)</h6>
                            <canvas id="latencyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                
                <script>
                    // Define data variables first
                    const labels = {{ labels|safe }};
                    const dataCpu = {{ data_cpu|safe }};
                    const dataRam = {{ data_ram|safe }};
                    const dataDisk = {{ data_disk|safe }}; // <--- NEW VARIABLE
                    const dataLatency = {{ data_latency|safe }};

                    // 1. Resource Chart Configuration
                    new Chart(document.getElementById('resourceChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'CPU %',
                                data: dataCpu,
                                borderColor: 'rgb(255, 99, 132)', // Red
                                tension: 0.1
                            }, {
                                label: 'RAM %',
                                data: dataRam,
                                borderColor: 'rgb(54, 162, 235)', // Blue
                                tension: 0.1
                            }, {
                                // --- NEW DISK DATASET ---
                                label: 'Disk %',
                                data: dataDisk,
                                borderColor: 'rgb(153, 102, 255)', // Purple
                                tension: 0.1
                            }]
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true, max: 100 }
                            }
                        }
                    });

                    // 2. Latency Chart Configuration
                    new Chart(document.getElementById('latencyChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Ping (ms)',
                                data: dataLatency,
                                borderColor: 'rgb(75, 192, 192)',
                                fill: true,
                                backgroundColor: 'rgba(75, 192, 192, 0.2)'
                            }]
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                </script>

            {% else %}
                <div class="alert alert-info">
                    Select a device from the left sidebar to view its performance history.
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}